/etc/clamav/clamd.conf (RECOMMENDED)


################################
# BASIC SETTINGS
################################
LogFile /var/log/clamav/clamd.log
LogTime yes
LogSyslog no
LogVerbose no

PidFile /run/clamav/clamd.pid
TemporaryDirectory /tmp

################################
# NETWORK (UNTUK NEXTCLOUD)
################################
TCPSocket 3310
TCPAddr 0.0.0.0

################################
# PERFORMANCE & RESOURCE
################################
MaxThreads 4
ReadTimeout 120
CommandReadTimeout 120

MaxScanSize 500M
StreamMaxLength 500M
MaxFileSize 200M

################################
# SCAN BEHAVIOR
################################
ScanArchive yes
ScanPE yes
ScanELF yes
ScanOLE2 yes
ScanPDF yes
ScanHTML yes
ScanMail yes
ScanPartialMessages yes

################################
# HEURISTIC & PUA
################################
DetectPUA yes
HeuristicAlerts yes
HeuristicScanPrecedence yes

################################
# ARCHIVE & COMPRESSION PROTECTION
################################
MaxRecursion 16
MaxFiles 20000
MaxEmbeddedPE 10M

################################
# SECURITY
################################
DisableCertCheck yes
AllowAllMatchScan yes
AlertEncryptedArchive yes
AlertEncryptedDoc yes

################################
# DATABASE
################################
DatabaseDirectory /var/lib/clamav
OfficialDatabaseOnly no

################################
# USER
################################
User clamav

################################
# SOCKET (OPTIONAL â€“ BISA DIMATIKAN)
################################
#LocalSocket /run/clamav/clamd.ctl
#LocalSocketMode 666






Siap ğŸ‘
Saya buatkan QoS Mikrotik KHUSUS untuk Nextcloud (100 user, Cloudflared / langsung), realistis & mudah diterapkan.

Saya beri 2 metode:
1ï¸âƒ£ Simple Queue (PALING MUDAH & STABIL) âœ…
2ï¸âƒ£ Queue Tree (LANJUTAN, lebih presisi)

Anda bisa pilih salah satu.

ğŸ¯ TARGET QoS

Asumsi internet:

Download 100 Mbps

Upload 50 Mbps

Nextcloud prioritas tinggi

Tetap adil untuk user lain

ğŸ”¹ METODE 1 â€” SIMPLE QUEUE (REKOMENDASI)
ğŸ“Œ Konsep

Limit total bandwidth Nextcloud

Bagi rata ke user

Mudah maintenance

1ï¸âƒ£ Tentukan IP Nextcloud

Misal:

IP Nextcloud : 192.168.10.50

2ï¸âƒ£ Buat Simple Queue (TOTAL)
/queue simple
add name="NEXTCLOUD-TOTAL" \
target=192.168.10.50 \
max-limit=50M/100M \
priority=1/1


ğŸ“Œ Artinya:

Upload max 50 Mbps

Download max 100 Mbps

Priority tertinggi

3ï¸âƒ£ Batasi Per User (Opsional tapi Disarankan)

Misal:

Upload: 2 Mbps

Download: 5 Mbps

/queue simple
add name="NEXTCLOUD-PER-USER" \
target=192.168.10.0/24 \
max-limit=2M/5M \
parent="NEXTCLOUD-TOTAL"


âœ” Tidak ada user yang â€œrakusâ€ bandwidth
âœ” Stabil saat jam sibuk

4ï¸âƒ£ Verifikasi
/queue simple print stats

ğŸ”¹ METODE 2 â€” QUEUE TREE (LEVEL LANJUTAN)

Lebih presisi, cocok jika jaringan besar.

1ï¸âƒ£ Buat Mangle (Mark Traffic Nextcloud)
/ip firewall mangle
add chain=forward dst-address=192.168.10.50 \
action=mark-connection new-connection-mark=nc_conn passthrough=yes

add chain=forward connection-mark=nc_conn \
action=mark-packet new-packet-mark=nc_pkt passthrough=no

2ï¸âƒ£ Buat Queue Tree
/queue tree
add name="NEXTCLOUD-UP" parent=global \
packet-mark=nc_pkt max-limit=50M priority=1

add name="NEXTCLOUD-DOWN" parent=global \
packet-mark=nc_pkt max-limit=100M priority=1

ğŸ” TIPS WAJIB AGAR STABIL

âœ” Aktifkan FastTrack EXCEPT Nextcloud

/ip firewall filter
add chain=forward action=fasttrack-connection \
connection-state=established,related \
dst-address=!192.168.10.50


âœ” Jangan FastTrack traffic Nextcloud
âœ” Jangan QoS di interface WAN kecil (CPU load)

ğŸ“Š REKOMENDASI NILAI REALISTIS
Parameter	Nilai
Per user upload	1â€“2 Mbps
Per user download	3â€“5 Mbps
Priority	1
Burst	Optional
âœ… REKOMENDASI SAYA

Untuk setup Anda:

ğŸ”¥ Gunakan SIMPLE QUEUE
Lebih stabil, minim error, mudah troubleshooting

ğŸ§ª TEST CEPAT

Upload file 500 MB

Buka YouTube di client lain
âœ” YouTube tidak lag
âœ” Upload tetap jalan

Mau saya buatkan:

QoS berdasarkan port 443 saja

QoS berdasarkan domain (SNI)

QoS Cloudflared khusus

Versi .rsc siap import

Diagram Mikrotik + Nextcloud

Tinggal bilang ğŸ‘



Kalau SEMUA aplikasi Anda lewat reverse proxy HTTPS (443), maka:

âŒ QoS berbasis port TIDAK BISA MEMBEDAKAN aplikasi
âŒ IP host LXD kena semua
âŒ Port 443 sama semua

Tapi tenang â€” masih ADA solusi yang BENAR & dipakai di production.

Saya jelaskan opsi yang REALISTIS dari yang bisa sekarang sampai paling ideal.

ğŸ§© KENAPA INI SULIT?

HTTPS terenkripsi â†’ router tidak tahu isinya

Semua lewat:

IP sama + port 443


Reverse proxy (Apache / Nginx / Traefik / Cloudflared)

â¡ï¸ Router tidak bisa bedakan Nextcloud, Cacti, UniFi, dll

ğŸŸ¢ SOLUSI YANG MASIH BISA DIPAKAI
ğŸ”¥ SOLUSI 1 â€” QoS BERDASARKAN SNI (TLS HOSTNAME) âœ…

ğŸ‘‰ INI PALING MASUK AKAL TANPA UBAH TOPOLOGI

Mikrotik BISA membaca SNI TLS (hostname HTTPS).

Contoh:
nextcloud.domain.com
cacti.domain.com
unifi.domain.com

1ï¸âƒ£ Mangle berdasarkan TLS Host (RouterOS v7)
/ip firewall mangle
add chain=forward protocol=tcp dst-port=443 \
tls-host=nextcloud.domain.com \
action=mark-connection new-connection-mark=nc_conn passthrough=yes

add chain=forward connection-mark=nc_conn \
action=mark-packet new-packet-mark=nc_pkt passthrough=no

2ï¸âƒ£ Queue Tree
/queue tree
add name="NC-UP" parent=global packet-mark=nc_pkt max-limit=50M priority=1
add name="NC-DOWN" parent=global packet-mark=nc_pkt max-limit=100M priority=1


âœ… Presisi
âœ… Tidak ganggu service lain
âš ï¸ Hanya RouterOS v7





Berikut penjelasan + contoh konfigurasi App Hardening Nextcloud yang dipakai di server produksi, bukan teori doang.
Saya susun bertingkat (Basic â†’ Pro) supaya jelas mana yang wajib dan mana yang opsional.

ğŸ” Apa itu App Hardening Nextcloud?

App hardening =

Mengurangi attack surface Nextcloud dengan:

menonaktifkan fitur tidak perlu

membatasi akses

mengunci perilaku aplikasi

memperketat session & autentikasi

Tujuannya:

Aman walau exposed ke internet (Cloudflared / reverse proxy)

Stabil untuk banyak user

Minim kebocoran data

ğŸ§± LEVEL 1 â€” HARDENING DASAR (WAJIB)
1ï¸âƒ£ Nonaktifkan aplikasi yang tidak dipakai

Ini wajib.

sudo -u www-data php occ app:disable talk
sudo -u www-data php occ app:disable mail
sudo -u www-data php occ app:disable richdocuments
sudo -u www-data php occ app:disable files_texteditor
sudo -u www-data php occ app:disable search_elasticsearch


ğŸ“Œ Alasan:

Talk â†’ WebRTC (besar attack surface)

Mail â†’ IMAP external (risk kredensial)

Office â†’ CPU/RAM berat

Search engine â†’ tidak perlu jika user sedikit

2ï¸âƒ£ Paksa HTTPS (walau pakai Cloudflared)

Di config.php:

'overwriteprotocol' => 'https',
'trusted_proxies' => ['127.0.0.1'],


ğŸ“Œ Ini penting agar:

session cookie aman

tidak redirect aneh ke IP private

3ï¸âƒ£ Matikan update otomatis app
'appstoreenabled' => true,
'appstore.experimental.enabled' => false,


Update manual = lebih aman.

ğŸ§± LEVEL 2 â€” SESSION & LOGIN HARDENING (PRO)
4ï¸âƒ£ Batasi durasi session login (jawaban dari pertanyaan kamu sebelumnya)
'session_lifetime' => 3600,        // 1 jam
'session_keepalive' => false,
'remember_login_cookie_lifetime' => 0,


ğŸ“Œ Efek:

User auto logout

Aman di PC umum

Cocok lingkungan kantor

5ï¸âƒ£ Batasi jumlah session per user
'limit_user_sessions' => true,


ğŸ“Œ User tidak bisa login dari banyak device sekaligus.

6ï¸âƒ£ Aktifkan proteksi brute force

(Default aktif, pastikan tidak dimatikan)

'auth.bruteforce.protection.enabled' => true,

ğŸ§± LEVEL 3 â€” FILE & SHARING HARDENING
7ï¸âƒ£ Matikan public share (jika internal only)
sudo -u www-data php occ config:system:set shareapi_allow_public_upload --type=boolean --value=false
sudo -u www-data php occ config:system:set shareapi_enabled --type=boolean --value=false


ğŸ“Œ Sangat disarankan untuk internal server.

8ï¸âƒ£ Disable preview file berat
'enable_previews' => true,
'enabledPreviewProviders' => [
  'OC\Preview\PNG',
  'OC\Preview\JPEG',
  'OC\Preview\GIF'
],


ğŸ“Œ Hindari:

video

pdf besar

file office

ğŸ§± LEVEL 4 â€” USER & ADMIN HARDENING
9ï¸âƒ£ Paksa 2FA untuk semua user
sudo -u www-data php occ app:enable twofactor_totp
sudo -u www-data php occ twofactorauth:enforce


ğŸ“Œ WAJIB jika exposed internet.

ğŸ”Ÿ Batasi hak admin

Gunakan:

admin (1 user)

group admin terbatas

sudo -u www-data php occ group:add admin-infra
sudo -u www-data php occ group:adduser admin-infra user1

ğŸ§± LEVEL 5 â€” BACKEND & SYSTEM HARDENING (ADVANCED)
11ï¸âƒ£ Redis untuk file locking
'memcache.locking' => '\OC\Memcache\Redis',
'redis' => [
  'host' => '/var/run/redis/redis.sock',
  'port' => 0,
],


ğŸ“Œ Wajib untuk stabilitas.

12ï¸âƒ£ Disable WebDAV anonymous behavior
'filesystem_check_changes' => 1,

ğŸ§ª Validasi Hardening (Checklist)
sudo -u www-data php occ security:certificates
sudo -u www-data php occ integrity:check-core
sudo -u www-data php occ app:list

ğŸ§  Ringkasan Paling Penting (INTI)

Kalau mau Nextcloud aman & stabil, minimal lakukan ini:

âœ… Disable app tidak perlu
âœ… Paksa HTTPS
âœ… Batasi session login
âœ… Aktifkan 2FA
âœ… Nonaktifkan public sharing
âœ… Redis locking

ğŸ“Œ Catatan Khusus Lingkungan Kamu (LXD + Cloudflared)

Rekomendasi tambahan:

1 container = 1 service

Jangan campur Cacti / Samba / UniFi di container yang sama

Nextcloud butuh:

RAM stabil

I/O disk konsisten

Kalau mau, saya bisa:

ğŸ” Review config.php kamu

ğŸ“„ Buat hardening checklist versi PDF

ğŸ§  Buat template hardening untuk portfolio

ğŸ§ª Simulasi audit security Nextcloud

Tinggal bilang ğŸ‘‰ lanjut ke mana





Ini konfigurasi FINAL & AMAN supaya:
âœ… Sinkronisasi Windows & Android TIDAK terganggu
âœ… Browser tetap dibatasi
âœ… Cocok untuk Cloudflared + LXD + produksi
âœ… Tidak bikin user sering login ulang
Saya buat step-by-step + alasan tiap setting.

ğŸ” KONFIGURASI SESSION NEXTCLOUD (PRODUKSI AMAN)
ğŸ¯ Target Konfigurasi
ItemHasilWindows clientâŒ tidak logoutAndroid appâŒ tidak logoutWeb browserâ±ï¸ auto logout jika idleJumlah devicedibatasi wajarSecuritytinggi

ğŸ§© STEP 1 â€” Edit config.php
Lokasi:
/var/www/nextcloud/config/config.php

Tambahkan / pastikan BARIS INI ADA:
/* === SESSION & LOGIN CONTROL === */
'limit_user_sessions' => true,

// Maksimal device:
// 1 Windows + 1 Android + 1 Browser
'max_user_sessions' => 3,

// Session browser (1 jam)
'session_lifetime' => 3600,

// BIARKAN true agar app client tidak logout
'session_keepalive' => true,

// Jangan simpan login lama di browser
'remember_login_cookie_lifetime' => 0,

/* === SECURITY === */
'auth.bruteforce.protection.enabled' => true,
'overwriteprotocol' => 'https',
'trusted_proxies' => ['127.0.0.1'],


ğŸ§  PENJELASAN (PENTING)
ğŸ”¹ max_user_sessions = 3
â¡ï¸ Aman untuk:


Windows client


Android app


Browser


â— Jangan pakai 2 kalau user aktif sync

ğŸ”¹ session_lifetime = 3600
â¡ï¸ Hanya berdampak ke browser
â¡ï¸ App client pakai token â†’ aman

ğŸ”¹ session_keepalive = true
â— WAJIB TRUE
Kalau false:


Android & Windows sering logout


Sync error



ğŸ”¹ remember_login_cookie_lifetime = 0
â¡ï¸ Browser tidak stay login
â¡ï¸ Aman di PC umum

ğŸ§ª STEP 2 â€” Validasi Konfigurasi
Jalankan:
sudo -u www-data php occ config:system:get max_user_sessions
sudo -u www-data php occ config:system:get session_lifetime
sudo -u www-data php occ config:system:get session_keepalive


ğŸ§ª STEP 3 â€” Test Nyata (WAJIB)
1ï¸âƒ£ Login via Windows client
2ï¸âƒ£ Login via Android app
3ï¸âƒ£ Login via Web browser
â¡ï¸ Total = 3 session (AMAN)
4ï¸âƒ£ Login browser ke-2
â¡ï¸ Browser lama logout
â¡ï¸ Sync tetap jalan
Cek:
sudo -u www-data php occ user:session:list username


ğŸ§± OPTIONAL (REKOMENDASI TAMBAHAN)
ğŸ” Aktifkan 2FA
sudo -u www-data php occ app:enable twofactor_totp
sudo -u www-data php occ twofactorauth:enforce


ğŸ› ï¸ User Khusus Backup
JANGAN pakai user biasa.
sudo -u www-data php occ user:add backupuser

ğŸ“Œ Backup user tidak dibatasi session (idealnya).

âš ï¸ KESALAHAN YANG SERING TERJADI (HINDARI)
âŒ max_user_sessions = 2
âŒ session_keepalive = false
âŒ Session terlalu pendek (<1800)

ğŸ RINGKASAN AMAN
âœ” Sync aman
âœ” Browser dibatasi
âœ” Tidak ganggu Android / Windows
âœ” Cocok untuk Cloudflared

Kalau mau, saya bisa:


ğŸ“„ Buat config.php versi final (downloadable)


ğŸ§  Buat policy user vs admin


ğŸ“Š Rekomendasi session untuk 50â€“100 user


ğŸ” Audit keamanan Nextcloud kamu


Tinggal bilang ğŸ‘‰ mau lanjut yang mana




	Display your Nextcloud version:

	sudo -u www-data php occ -V
	Nextcloud version 19.0.0

 	Apps commands
	The app commands list, enable, and disable apps:
	app
	app:install install selected app
	app:disable disable an app
	app:enable enable an app
	app:getpath get an absolute path to the app directory
	app:list list all available apps
	app:update update an app or all apps
	app:remove disable and remove an app


	Download and install an app:
	sudo -u www-data php occ app:install twofactor_totp
	Install but donâ€™t enable:
	sudo -u www-data php occ app:install --keep-disabled twofactor_totp
	List all of your installed apps, and show whether they are enabled or disabled:
	sudo -u www-data php occ app:list
	Enable an app, for example the External Storage Support app:
	sudo -u www-data php occ app:enable files_external
	files_external enabled
	Disable an app:
	sudo -u www-data php occ app:disable files_external
	files_external disabled
	You can get the full filepath to an app:
	sudo -u www-data php occ app:getpath notifications
	/var/www/nextcloud/apps/notifications
	To update an app, for instance Contacts:
	sudo -u www-data php occ app:update contacts
	To update all apps:
	sudo -u www-data php occ app:update --all

	Transfer File 
	sudo -u www-data php occ files:transfer-ownership <source-user> <destination-user>
	sudo -u www-data php occ files:transfer-ownership --move <source-user> <destination-,â†’user>
	sudo -u www-data php occ files:transfer-ownership --path="path_to_dir" <source-user>,â†’<destination-user>
	sudo -u www-data php occ files:transfer-ownership --transfer-incoming-shares=1 --path=,â†’"path_to_dir" <source-user> <destination-user>
	sudo -u www-data php occ files:transfer-ownership --transfer-incoming-shares=1 --path=,â†’"path_to_dir" <source-user> <destination-user>



	
