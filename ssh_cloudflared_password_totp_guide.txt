
Panduan Lengkap: SSH via Cloudflared dengan Otentikasi Password + TOTP (Google Authenticator)
============================================================================================

Deskripsi singkat
-----------------
Panduan ini menjelaskan langkah-langkah dari awal sampai akhir untuk mengamankan akses SSH server
Ubuntu (mis. server LXD) menggunakan kombinasi Password + TOTP (Google Authenticator), serta
meneruskan akses SSH melalui Cloudflare Tunnel (cloudflared) sehingga tidak butuh IP publik atau
port forwarding. Ikuti dengan hati-hati dan jangan memutus sesi admin aktif sampai pengujian selesai.

CATATAN PENTING SEBELUM MULAI
-----------------------------
1) Jangan melakukan perubahan di sesi SSH yang sedang aktif tanpa membuka sesi SSH baru untuk tes.
2) Siapkan akses fisik/KVM/console atau user fallback (sudah disertakan langkah membuatnya).
3) Simpan QR secret TOTP di tempat aman — bila HP hilang, akses akan sulit tanpa backup.
4) Backup file konfigurasi sebelum diubah (perintah ada di langkah).

A. Persiapan & Backup (server)
-------------------------------
1. Login ke server sebagai user dengan sudo.
2. Backup konfigurasi SSH & PAM:
   sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak
   sudo cp /etc/pam.d/sshd /etc/pam.d/sshd.bak
3. (Opsional tapi disarankan) Buat user fallback untuk jaga-jaga:
   sudo adduser fallbackadmin
   sudo usermod -aG sudo fallbackadmin
   # Set password dan simpan aman.

B. Install Google Authenticator PAM (server)
--------------------------------------------
1. Update & install paket:
   sudo apt update
   sudo apt install -y libpam-google-authenticator
2. Untuk setiap user yang akan login via SSH (mis. 'ubuntu'), jalankan secara interaktif:
   sudo -u ubuntu google-authenticator
   Jawab pilihan (contoh):
     Do you want authentication tokens to be time-based (y/n) y
     Do you want me to update your .bash_profile? (y/n) y   # opsional
     Disallow multiple uses of the same token? (y/n) y
     Increase the time skew? (y/n) n
     Do you want to enable rate-limiting? (y/n) y
   - Scan QR code dengan aplikasi TOTP (Google Authenticator, Authy, Aegis).
   - Catat emergency scratch codes & secret key (backup offline).

3. (Alternatif non-interaktif untuk banyak user - HATI-HATI)
   google-authenticator -t -d -f -r 3 -R 30 -W
   # Output berisi secret & emergency codes — simpan dengan aman.

C. Konfigurasi PAM untuk SSH
-----------------------------
1. Edit /etc/pam.d/sshd dan tambahkan baris paling atas:
   auth required pam_google_authenticator.so
   # Jika ingin beri pengecualian untuk user tanpa TOTP, tambahkan 'nullok':
   # auth required pam_google_authenticator.so nullok
2. Contoh perintah untuk sisip otomatis:
   sudo sed -i '1iauth required pam_google_authenticator.so' /etc/pam.d/sshd

D. Konfigurasi SSH (Password + TOTP)
------------------------------------
1. Edit file /etc/ssh/sshd_config (backup sudah dibuat di bagian A).
2. Pastikan/ubah parameter berikut:
   UsePAM yes
   ChallengeResponseAuthentication yes
   PasswordAuthentication yes
   AuthenticationMethods keyboard-interactive,password
   # Keterangan:
   # - PasswordAuthentication yes : mengizinkan verifikasi password Linux.
   # - keyboard-interactive memicu PAM (yang meminta TOTP).
   # - AuthenticationMethods keyboard-interactive,password memastikan kedua metode diperlukan.
3. Simpan perubahan dan restart SSH:
   sudo systemctl restart ssh

E. Uji Otentikasi Lokal / Jaringan (SANGAT PENTING)
--------------------------------------------------
1. Jangan tutup sesi admin saat ini. Buka terminal/client berbeda.
2. Coba login:
   ssh ubuntu@IP-server
   # Harus diminta:
   Password:
   Verification code:
3. Masukkan password lalu 6-digit TOTP dari aplikasi. Jika login berhasil, konfigurasi SSH working.
4. Jika gagal dan kamu kehilangan akses, kembalikan backup dari sesi admin:
   sudo cp /etc/ssh/sshd_config.bak /etc/ssh/sshd_config
   sudo cp /etc/pam.d/sshd.bak /etc/pam.d/sshd
   sudo systemctl restart ssh

F. Install cloudflared dan buat Tunnel (server)
-----------------------------------------------
1. Pasang cloudflared (cara resmi):
   curl -fsSL https://pkg.cloudflare.com/install.sh | sudo bash
   sudo apt update
   sudo apt install -y cloudflared
2. Login cloudflared (akan membuka browser untuk otorisasi Cloudflare):
   sudo cloudflared tunnel login
   # Ikuti instruksi di browser. Pastikan domain/subdomain berada di akun Cloudflare yang sama.
3. Buat tunnel:
   sudo cloudflared tunnel create ssh-tunnel
   # Catat output tunnel ID, misal: 7e7e1d29-xxxx-...
4. Buat file konfigurasi /etc/cloudflared/config.yml :
   tunnel: <TUNNEL_ID>
   credentials-file: /root/.cloudflared/<TUNNEL_ID>.json

   ingress:
     - hostname: ssh.example.com
       service: ssh://localhost:22
     - service: http_status:404
   # Ganti ssh.example.com dengan domain/subdomain yang kamu miliki di Cloudflare.
5. Buat route DNS (jalankan sebagai user yang melakukan 'cloudflared tunnel login'):
   cloudflared tunnel route dns ssh-tunnel ssh.example.com
6. Install cloudflared sebagai service dan jalankan:
   sudo cloudflared service install
   sudo systemctl enable --now cloudflared
   sudo systemctl status cloudflared

G. Client: Koneksi lewat Cloudflared (direkomendasikan menggunakan Access mode)
-------------------------------------------------------------------------------
Opsi A - Menggunakan cloudflared access (direkomendasikan):
1. Pasang cloudflared di client (Linux/macOS/Windows). Lihat dokumentasi Cloudflare.
2. Login Access (jika menggunakan Cloudflare Access / Teams):
   cloudflared access login
   # Browser akan terbuka; login ke Cloudflare / IdP jika perlu.
3. Jalankan koneksi SSH via access:
   cloudflared access ssh --hostname ssh.example.com --remote-user ubuntu
   # Perintah ini membuka proxy dan biasanya memicu SSH; jika tidak, catat port lokal yang diberikan, lalu:
   ssh ubuntu@localhost -p <LOCAL_PORT>
4. Saat SSH, masukkan password Linux user lalu TOTP.

Opsi B - Jika tidak menggunakan Access, gunakan local proxy:
1. Jalankan pada client (contoh):
   cloudflared tunnel --url ssh://ssh.example.com run ssh-tunnel
   # Metode ini tidak se-aman Access; Access memberikan kontrol policy & MFA.

H. Tips keamanan & praktik terbaik
---------------------------------
• Simpan backup file ~/.google_authenticator (secret key & scratch codes) di tempat aman & terenkripsi (offline).
• Jika kamu ingin menambahkan hardware token (YubiKey), gunakan pam_u2f (libpam-u2f).
• Gunakan user fallback dan pastikan akses KVM/console tersedia jika terjadi lockout.
• Gunakan firewall (ufw/nftables) untuk batasi akses hanya ke port penting; Cloudflared akan membuat koneksi outbound sehingga port 22 tetap tertutup ke publik.
• Dokumentasikan semua langkah & simpan backup konfigurasi di repositori internal jika perlu.

I. Rollback cepat jika terkunci
-------------------------------
Jika kamu kehilangan akses SSH setelah restart:
1. Akses console fisik / KVM / remote management. Jika tidak ada, minta provider VPS memberi akses console.  
2. Dari console: restore backup:
   sudo cp /etc/ssh/sshd_config.bak /etc/ssh/sshd_config
   sudo cp /etc/pam.d/sshd.bak /etc/pam.d/sshd
   sudo systemctl restart ssh
3. Jika masih bermasalah, periksa file ~/.google_authenticator untuk user yang bermasalah. Pastikan permission file benar (600).

J. Checklist sebelum menutup sesi admin
--------------------------------------
[ ] Sudah membuat user fallback dengan password.  
[ ] Sudah backup konfigurasi SSH & PAM.  
[ ] Sudah menjalankan google-authenticator untuk user dan memindai QR code.  
[ ] Sudah menguji SSH dari client lain (password + TOTP).  
[ ] cloudflared tunnel dibuat dan service berjalan.  
[ ] Mencatat / menyimpan secret TOTP & emergency codes di tempat aman.

K. Referensi singkat
--------------------
• Cloudflare Tunnel docs: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/  
• Google Authenticator PAM: man page libpam-google-authenticator  
• OpenSSH: sshd_config manual

-- END OF DOCUMENT --
