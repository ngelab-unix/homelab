Baik, saya jelaskan step-by-step sampai berhasil akses MinIO dari luar jaringan menggunakan:

S3 Browser / WinSCP S3 / Cyberduck

Akses via Access Key + Secret Key

Topologi Cloudflared â†’ Mikrotik â†’ CASAOS host â†’ Docker MinIO

Reverse proxy dilakukan di LXD (Nginx)

ğŸŸ¦ TOPOLOGI YANG ANDA PAKAI

Saya rangkum topologinya:

Internet
   â†“
Cloudflare Tunnel (cloudflared)
   â†“
Mikrotik (NAT / Firewall)
   â†“
CASAOS Host (192.168.20.12)
   â†“
Docker MinIO port 9010
   â†“
LXD Host Canonical 192.168.1.15
   â†“
Container DNS + Cloudflare-Connector + Nginx (10.105.30.20)


Anda ingin agar S3 Browser dari Internet bisa login ke MinIO melalui:

âœ” Domain
âœ” SSL Cloudflare
âœ” Reverse proxy Nginx di LXD
âœ” Access Key + Secret Key
âœ” Port default S3: 443

	ğŸŸ© LANGKAH 1 â€” Tentukan Domain MinIO Anda

	Misalnya Anda ingin akses:
	s3.srvlab.my.id

	ğŸŸ§ LANGKAH 2 â€” Tambah Routing Cloudflared (Tunnel â†’ Nginx LXD)

	Masuk ke cloudflared container (DNS + cloudflared):
	di file /etc/cloudflared/config.yml

	Tambahkan:
tunnel: your-tunnel-id
credentials-file: /etc/cloudflared/your-tunnel-id.json

ingress:
  - hostname: s3.srvlab.my.id
    service: http://10.105.30.20:443
  - service: http_status:404

	âš  NOTE
	Service ke LXD nginx pakai port 443 internal (jika nginx Anda pakai SSL).
	Jika tidak, pakai port 80.

	ğŸŸ¦ LANGKAH 3 â€” Reverse Proxy di NGINX (LXD 10.105.30.20)
	ğŸ“Œ File: /etc/nginx/sites-available/minio.conf
	
	Gunakan reverse proxy aman untuk S3 API:

server {
    listen 443 ssl;
    server_name s3.srvlab.my.id;

    ssl_certificate /etc/letsencrypt/live/s3.srvlab.my.id/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/s3.srvlab.my.id/privkey.pem;

    client_max_body_size 100G;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 300;
        proxy_read_timeout 300;
        proxy_http_version 1.1;

        proxy_pass http://192.168.20.12:9010;
    }
}



	Aktifkan:
	ln -s /etc/nginx/sites-available/minio.conf /etc/nginx/sites-enabled/

	systemctl reload nginx

	ğŸŸª LANGKAH 4 â€” Pastikan MinIO Mengizinkan Reverse Proxy

	Modifikasi docker compose / command MinIO Anda:
	Tambahkan:

	MINIO_SERVER_URL=https://s3.srvlab.my.id
	MINIO_BROWSER_REDIRECT_URL=https://s3.srvlab.my.id

	Contoh di Docker Compose:
	environment:
  	- MINIO_ROOT_USER=ADMIN
  	- MINIO_ROOT_PASSWORD=xxxxxxxx
  	- MINIO_SERVER_URL=https://s3.srvlab.my.id
  	- MINIO_BROWSER_REDIRECT_URL=https://s3.srvlab.my.id

	Restart MinIO:
	docker restart minio



Baik, saya buatkan paket lengkap sesuai permintaan Anda. Semua sudah saya sesuaikan dengan topologi Anda yang memakai:

Cloudflared

Mikrotik

Host Container â†’ Docker MinIO (port 9010)

LXD Host (DNS + NGINX Reverse Proxy)

Akses dari luar menggunakan S3 Browser, MinIO Client (mc), dll.

ğŸŸ¦ 1. RANCANGAN STORAGE MINIO (BEST PRACTICE)
A. Struktur Folder / Storage

Gunakan struktur berikut:

/data/minio/
    â”œâ”€â”€ hrd/
    â”œâ”€â”€ finance/
    â”œâ”€â”€ it/
    â””â”€â”€ backup/

B. Arsitektur Storage

Untuk server single node:

Disk 1: OS

Disk 2: Data MinIO (S3)

Gunakan ZFS / RAID1 agar aman jika disk mati.

Jika Anda ingin durable:

RAID10 â†’ high performance

ZFS RAIDZ2 â†’ durable untuk backup

MinIO sangat bagus jika memakai disk khusus, jangan campurkan dengan OS!

ğŸŸ¦ 2. POLICY PER DIVISI (HRD, FINANCE, IT)
Policy 1 â€” HRD upload-only (tidak bisa hapus)
{
 "Version": "2012-10-17",
 "Statement": [
   {
     "Effect": "Allow",
     "Action": ["s3:PutObject"],
     "Resource": ["arn:aws:s3:::hrd/*"]
   },
   {
     "Effect": "Allow",
     "Action": ["s3:ListBucket"],
     "Resource": ["arn:aws:s3:::hrd"]
   }
 ]
}

Policy 2 â€” Finance full access bucket-nya sendiri
{
 "Version": "2012-10-17",
 "Statement": [
   {
     "Effect": "Allow",
     "Action": ["s3:*"],
     "Resource": ["arn:aws:s3:::finance/*", "arn:aws:s3:::finance"]
   }
 ]
}

Policy 3 â€” IT admin (akses semua bucket)
{
 "Version": "2012-10-17",
 "Statement": [
   {
     "Effect": "Allow",
     "Action": ["s3:*"],
     "Resource": ["arn:aws:s3:::*"]
   }
 ]
}


Nanti akan saya sertakan perintah mc admin policy import pada tahap instalasi.

ğŸŸ¦ 3. ARSITEKTUR JARINGAN LENGKAP
Internal Topologi
USER â†’ Cloudflared Tunnel â†’ Domain â†’ Reverse Proxy (NGINX) â†’ MinIO Container

Detail IP
Komponen	IP	Keterangan
Host Docker (MinIO)	192.168.20.12	Port 9010
LXD Host + NGINX	10.105.30.20	Reverse Proxy SSL
Mikrotik	â€“	Router
Cloudflared	â€“	Endpoint domain menuju NGINX
Akses eksternal
s3.company.com â†’ cloudflared â†’ nginx â†’ http://192.168.20.12:9010

ğŸŸ¦ 4. DIAGRAM TOPOLOGI MINIO + REVERSE PROXY
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚        Internet           â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                   Cloudflared Tunnel
                                           â”‚
                                 s3.company.com (HTTPS)
                                           â”‚
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚   LXD NGINX Reverse Proxy â”‚
                             â”‚   IP: 10.105.30.20        â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚ HTTP
                                           â”‚
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚     Docker Host MinIO     â”‚
                             â”‚     IP: 192.168.20.12     â”‚
                             â”‚     Port: 9010            â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â”‚ S3 API
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                        USERS                           â”‚
              â”‚ S3 Browser | mc CLI | Apps Backup | Nextcloud | IT Ops â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸŸ¦ 5. STEP-BY-STEP INSTALLASI MINIO + MC + POLICY + NGINX
âœ… STEP 1 â€” Install MinIO di Docker Host

Buat folder data:

sudo mkdir -p /data/minio
sudo chmod 777 /data/minio


Jalankan MinIO:

docker run -d --name minio \
  -p 9010:9000 \
  -e MINIO_ROOT_USER=admin \
  -e MINIO_ROOT_PASSWORD=Admin123! \
  -v /data/minio:/data \
  minio/minio server /data --console-address ":9001"


Console MinIO nanti di:

http://192.168.20.12:9001

âœ… STEP 2 â€” Install MinIO Client (mc)

Di server LXD atau mesin admin mana saja:

curl https://dl.min.io/client/mc/release/linux-amd64/mc -o mc
chmod +x mc
sudo mv mc /usr/local/bin/


Tambahkan MinIO Anda:

mc alias set local http://192.168.20.12:9010 admin Admin123!

âœ… STEP 3 â€” Buat Bucket per Divisi
mc mb local/hrd
mc mb local/finance
mc mb local/it

âœ… STEP 4 â€” Import Policy Divisi

Buat file dan import:

HRD:
mc admin policy add local hrd-upload-only hrd-policy.json

Finance:
mc admin policy add local finance-full finance-policy.json

IT:
mc admin policy add local it-admin it-policy.json

âœ… STEP 5 â€” Buat User dan Assign Policy
HRD user
mc admin user add local hrduser HRDsecret123
mc admin policy set local hrd-upload-only user=hrduser

Finance user
mc admin user add local financeuser FINsecret123
mc admin policy set local finance-full user=financeuser

IT admin
mc admin user add local itadmin ITsecret123
mc admin policy set local it-admin user=itadmin

âœ… STEP 6 â€” Setup NGINX Reverse Proxy (di LXD container)

File vhost:

/etc/nginx/sites-available/minio.conf


Isi:

server {
    listen 443 ssl;
    server_name s3.company.com;

    ssl_certificate /etc/ssl/company/fullchain.pem;
    ssl_certificate_key /etc/ssl/company/privkey.pem;

    location / {
        proxy_pass http://192.168.20.12:9010;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}


Aktifkan:

ln -s /etc/nginx/sites-available/minio.conf /etc/nginx/sites-enabled/
nginx -t
systemctl restart nginx

âœ… STEP 7 â€” Cloudflared Tunnel

Arahkan domain:

s3.company.com â†’ http://10.105.30.20:443


Cloudflared command:

tunnel: your_tunnel_id
ingress:
  - hostname: s3.company.com
    service: https://10.105.30.20
  - service: http_status:404


Restart cloudflared.

ğŸŸ¦ 6. Akses dari luar menggunakan S3 Browser

Masukkan:

Endpoint: https://s3.company.com

Access Key: (misalnya user HRD)

Secret Key: (HRDsecret123)

Region: us-east-1 (bebas)

Kemudian S3 Browser akan terhubung.

















Siap, saya tulis ulang dari nol semua langkah step-by-step untuk:

âœ” Instalasi MinIO
âœ” Konfigurasi S3 port 9000/9001
âœ” Reverse Proxy NGINX
âœ” Konfigurasi Cloudflared Tunnel
âœ” Pastikan akses S3 (API) bisa dari luar
âœ” Pastikan akses Console Web juga bisa

Catatan Penting Masalah Anda:

Web Console (port 9001) sudah bisa via https://minio.ngelab-unix.biz.id

S3 API (port 9000) belum bisa via ducks3 / aplikasi â†’ berarti reverse proxy untuk port 9000 belum benar atau Cloudflared tidak expose port 9000

Sekarang kita tulis ulang konfigurasinya dari awal dan paling bersih.

âœ… 1. INSTALL MINIO SERVER (NATIVE LINUX, BUKAN DOCKER)

Agar lebih stabil & mudah debug.

1.1 Download MinIO
wget https://dl.min.io/server/minio/release/linux-amd64/minio
chmod +x minio
mv minio /usr/local/bin/

1.2 Buat folder penyimpanan
mkdir -p /data/minio

1.3 Buat user MinIO
useradd -r minio-user -s /sbin/nologin
chown -R minio-user:minio-user /data/minio

1.4 Buat file service systemd

/etc/systemd/system/minio.service

[Unit]
Description=MinIO
After=network.target

[Service]
User=minio-user
Group=minio-user
ExecStart=/usr/local/bin/minio server /data/minio --console-address ":9001" --address ":9000"
Restart=always
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target

1.5 Start MinIO
systemctl daemon-reload
systemctl enable --now minio

âœ… 2. KONFIGURASI FIREWALL SERVER

Pastikan port internal MinIO terbuka:

ufw allow 9000
ufw allow 9001

âœ… 3. NGINX REVERSE PROXY (PORT 9000 & 9001)

Kami akan membuat:

âœ” minio.ngelab-unix.biz.id â†’ MinIO Console (port 9001)
âœ” s3.ngelab-unix.biz.id â†’ S3 API (port 9000)
3.1 Buat file NGINX:
1) /etc/nginx/conf.d/minio-console.conf
server {
    listen 80;
    server_name minio.ngelab-unix.biz.id;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name minio.ngelab-unix.biz.id;

    ssl_certificate /etc/letsencrypt/live/minio.ngelab-unix.biz.id/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/minio.ngelab-unix.biz.id/privkey.pem;

    location / {
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;

        proxy_pass http://127.0.0.1:9001;
    }
}

2) /etc/nginx/conf.d/s3-api.conf
server {
    listen 80;
    server_name s3.ngelab-unix.biz.id;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name s3.ngelab-unix.biz.id;

    ssl_certificate /etc/letsencrypt/live/s3.ngelab-unix.biz.id/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/s3.ngelab-unix.biz.id/privkey.pem;

    client_max_body_size 0;

    location / {
        proxy_set_header Host $http_host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Real-IP $remote_addr;

        proxy_pass http://127.0.0.1:9000;
    }
}

3.2 Reload NGINX
nginx -t
systemctl reload nginx

âœ… 4. KONFIGURASI CLOUDFLARED TUNNEL
4.1 Masuk Cloudflare Tunnel
cloudflared tunnel login

4.2 Buat tunnel
cloudflared tunnel create minio-tunnel

4.3 Edit routing tunnel

~/.cloudflared/config.yml

tunnel: minio-tunnel
credentials-file: /root/.cloudflared/minio-tunnel.json

ingress:
  - hostname: minio.ngelab-unix.biz.id
    service: https://localhost:9001

  - hostname: s3.ngelab-unix.biz.id
    service: https://localhost:9000

  - service: http_status:404


âš  Perhatikan:
Karena kita memakai NGINX SSL, maka service Cloudflared sebaiknya HTTP â†’ HTTPS local.
Jika NGINX Anda SSL terminator, ganti ke:

  - hostname: minio.ngelab-unix.biz.id
    service: http://localhost:443

  - hostname: s3.ngelab-unix.biz.id
    service: http://localhost:443


Jika Anda mau saya cek lengkap, kirim config Anda.

ğŸ” 5. CHECK LIST AGAR S3 BISA DARI LUAR
Fungsi	Domain	Port Asli	Status
Web Console	minio.ngelab-unix.biz.id	9001	âœ” Sudah jalan
S3 API	s3.ngelab-unix.biz.id	9000	âŒ belum â†’ yang harus diperbaiki
mc CLI (linux)	â€”	9000	âœ” jalan
local PC	â€”	9000	âœ” jalan

ğŸ”¥ Artinya:
NGINX atau Cloudflared untuk port 9000 belum benar.

ğŸ”§ 6. TEST DARI LUAR (S3 API)
Test 1
curl -I https://s3.ngelab-unix.biz.id


Hasil harus 200 MinIO.

Test 2

Ducks3 / S3 Browser pakai:

S3 Endpoint: https://s3.ngelab-unix.biz.id
Access Key: xxxxxxx
Secret Key: xxxxxxx
Region: us-east-1

ğŸ¯ Kirimkan hal berikut biar saya perbaiki langsung:

cat /etc/nginx/conf.d/s3-api.conf

cat ~/.cloudflared/config.yml

Output curl -I https://s3.ngelab-unix.biz.id

Nanti saya perbaiki config Anda sampai benar-benar bisa remote S3.

